// --- PREGUNTAS ---
const preguntas = [
  {
  texto: "Quina és la finalitat principal de la Directiva IPPC (61/1996)?",
  opciones: [
    "a) Fomentar el comerç entre països europeus",
    "b) Prevenir i controlar de manera integrada la contaminació industrial",
    "c) Millorar la seguretat laboral a les indústries",
    "d) Promoure la innovació tecnològica en energia nuclear"
  ],
  correcta: "b"
},
{
  texto: "Com s’anomena actualment la Directiva IPPC?",
  opciones: [
    "a) Directiva sobre emissions industrials",
    "b) Directiva de prevenció de riscos laborals",
    "c) Directiva sobre desenvolupament sostenible",
    "d) Directiva de residus urbans"
  ],
  correcta: "a"
},
{
  texto: "Quin és l’objectiu principal de la Directiva 75/2010/UE sobre emissions industrials?",
  opciones: [
    "a) Reunir en un únic text les directives anteriors sobre contaminació",
    "b) Establir nous impostos sobre residus",
    "c) Definir els límits de soroll en zones urbanes",
    "d) Promoure l’ús d’energies renovables"
  ],
  correcta: "a"
},
{
  texto: "En què es basa el principi de 'prevenció i control integrat'?",
  opciones: [
    "a) En actuar només sobre les emissions atmosfèriques",
    "b) En prevenir o reduir les emissions a l’aire, a l’aigua i al sòl d’una manera coordinada",
    "c) En millorar la rendibilitat de les empreses",
    "d) En centralitzar totes les competències al Parlament Europeu"
  ],
  correcta: "b"
},
{
  texto: "Segons la Directiva, què passa si una activitat industrial no pot prevenir la contaminació?",
  opciones: [
    "a) Ha de compensar econòmicament altres empreses",
    "b) Ha de reduir les emissions al mínim tècnicament possible",
    "c) Pot continuar operant sense límit",
    "d) Ha de tancar temporalment"
  ],
  correcta: "b"
},
{
  texto: "Quant temps tenen els estats membres per transposar una directiva europea al seu marc legal?",
  opciones: [
    "a) 6 mesos",
    "b) 1 any",
    "c) 2 anys",
    "d) 5 anys"
  ],
  correcta: "c"
},
{
  texto: "Quin article estableix l’objecte principal de la Directiva 75/2010?",
  opciones: [
    "a) Article 1",
    "b) Article 11",
    "c) Article 22",
    "d) Article 30"
  ],
  correcta: "a"
},
{
  texto: "De què depèn la classificació d’una activitat dins l’Annex I de la Directiva?",
  opciones: [
    "a) De la localització geogràfica",
    "b) Del tipus d’activitat i la seva capacitat productiva",
    "c) Del nombre d’empleats",
    "d) Del pressupost de l’empresa"
  ],
  correcta: "b"
},
{
  texto: "Què estableix l’article 11 de la Directiva sobre les obligacions de l’operador?",
  opciones: [
    "a) Que ha d’aplicar les millors tècniques disponibles i utilitzar energia eficientment",
    "b) Que ha de prioritzar el benefici econòmic",
    "c) Que ha de reduir només la contaminació acústica",
    "d) Que pot decidir lliurement els valors límit d’emissió"
  ],
  correcta: "a"
},
{
  texto: "Quin és un dels principis generals de l’operador segons la Directiva?",
  opciones: [
    "a) Adoptar mesures preventives contra la contaminació",
    "b) Augmentar la producció sense límits",
    "c) Subcontractar la gestió ambiental",
    "d) Evitar auditories externes"
  ],
  correcta: "a"
},
{
  texto: "Segons l’article 12, què ha d’incloure una sol·licitud de permís ambiental?",
  opciones: [
    "a) Només la descripció de les activitats principals",
    "b) Informació sobre matèries primeres, emissions previstes i tecnologia emprada",
    "c) Només el pla financer de l’empresa",
    "d) Dades sobre el nombre d’empleats"
  ],
  correcta: "b"
},
{
  texto: "Què s’entén per Millors Tècniques Disponibles (MTD)?",
  opciones: [
    "a) Les tècniques més barates disponibles al mercat",
    "b) Les tècniques més avançades i efectives per reduir emissions sense perjudicar l’economia",
    "c) Només les tècniques que utilitzen energia renovable",
    "d) Totes les tècniques experimentals"
  ],
  correcta: "b"
},
{
  texto: "Les MTD (Millors Tècniques Disponibles) tenen en compte:",
  opciones: [
    "a) Només el cost econòmic",
    "b) El cost, la ubicació i les condicions locals",
    "c) Només la productivitat",
    "d) Només la tecnologia emprada"
  ],
  correcta: "b"
},
{
  texto: "Què són els Valors Límit d’Emissió (VLE)?",
  opciones: [
    "a) Els nivells màxims d’emissió que no es poden superar en un període determinat",
    "b) El consum màxim d’energia per unitat de producte",
    "c) Els valors mínims d’emissió per a una indústria",
    "d) Els límits econòmics de la producció"
  ],
  correcta: "a"
},
{
  texto: "En què es basen els Valors Límit d’Emissió (VLE)?",
  opciones: [
    "a) En les Millors Tècniques Disponibles (MTD)",
    "b) En la voluntat de cada empresa",
    "c) En les emissions mitjanes d’un país",
    "d) En la densitat de població"
  ],
  correcta: "a"
},
{
  texto: "Què són els Documents de Referència (BREF)?",
  opciones: [
    "a) Documents que descriuen les MTD i emissions actuals per sectors industrials",
    "b) Guies de seguretat laboral",
    "c) Informes econòmics de la UE",
    "d) Manuals de gestió energètica"
  ],
  correcta: "a"
},
{
  texto: "Qui redacta els Documents de Referència (BREF)?",
  opciones: [
    "a) Grups de treball europeus que intercanvien informació i arriben a consens sobre les MTD",
    "b) Cada empresa individualment",
    "c) Els governs locals",
    "d) Les ONG ambientals"
  ],
  correcta: "a"
},
{
  texto: "Cada quant temps s’haurien d’actualitzar els Documents de Referència (BREF)?",
  opciones: [
    "a) Cada 2 anys",
    "b) Cada 5 anys",
    "c) Cada 8 anys",
    "d) Cada 10 anys"
  ],
  correcta: "c"
},
{
  texto: "Segons la Directiva, quina és la definició d’emissió?",
  opciones: [
    "a) Alliberament directe o indirecte de substàncies, vibracions, calor o soroll al medi ambient",
    "b) Només la sortida de gasos per una xemeneia",
    "c) Només les emissions líquides a l’aigua",
    "d) La quantitat de productes fabricats"
  ],
  correcta: "a"
},
{
  texto: "Quin objectiu tenen els permisos ambientals segons la Directiva d’Emissions Industrials?",
  opciones: [
    "a) Permetre operar sota condicions controlades per reduir l’impacte ambiental",
    "b) Autoritzar qualsevol tipus d’activitat sense restriccions",
    "c) Recaudar impostos ambientals",
    "d) Facilitar la construcció de noves infraestructures"
  ],
  correcta: "a"
},
{
  texto: "Quina era la normativa espanyola que classificava activitats com a molestes, insalubres, nocives i perilloses?",
  opciones: [
    "a) Decret 2414/1961 (RAMINP)",
    "b) Llei 16/2002",
    "c) Llei 21/1990",
    "d) Reial Decret 815/2013"
  ],
  correcta: "a"
},
{
  texto: "Quina era la naturalesa del Reglament RAMINP (1961)?",
  opciones: [
    "a) Preventiva i amb controls periòdics",
    "b) Proteccionista, amb una única inspecció inicial i permís indefinit",
    "c) Basada en la sostenibilitat i l’eficiència energètica",
    "d) Focalitzada només en residus urbans"
  ],
  correcta: "b"
},
{
  texto: "Quin era un problema del RAMINP segons els apunts?",
  opciones: [
    "a) Que només es controlava la contaminació atmosfèrica",
    "b) Que tenia una aproximació separativa amb moltes administracions implicades",
    "c) Que no permetia construir noves fàbriques",
    "d) Que no existia cap inspecció inicial"
  ],
  correcta: "b"
},
{
  texto: "Quina llei espanyola va transposar la Directiva IPPC al marc legal estatal?",
  opciones: [
    "a) Llei 16/2002",
    "b) Llei 20/2009",
    "c) Reial Decret 2414/1961",
    "d) Llei 3/1998"
  ],
  correcta: "a"
},
{
  texto: "Quin Reial Decret desenvolupa la Llei 16/2002 sobre Prevenció i Control Integrats de la Contaminació?",
  opciones: [
    "a) Reial Decret 815/2013",
    "b) Reial Decret 100/2010",
    "c) Reial Decret 120/2008",
    "d) Reial Decret 777/2015"
  ],
  correcta: "a"
},
{
  texto: "Quin text refós aprova la Llei sobre Prevenció i Control Integrats de la Contaminació?",
  opciones: [
    "a) Reial Decret Legislatiu 1/2016",
    "b) Llei 3/1998",
    "c) Reial Decret 815/2013",
    "d) Llei 21/1990"
  ],
  correcta: "a"
},
{
  texto: "Quantes instal·lacions formaven part de l’Annex I de la Llei 16/2002 l’any 2024?",
  opciones: [
    "a) 2.000",
    "b) 5.500",
    "c) 9.033",
    "d) 12.000"
  ],
  correcta: "c"
},
{
  texto: "Quina llei catalana va transposar la Directiva IPPC al marc legal autonòmic?",
  opciones: [
    "a) Llei 3/1998 (LIIAA)",
    "b) Llei 16/2002",
    "c) Llei 20/2009 (PCAA)",
    "d) Decret 2414/1961"
  ],
  correcta: "a"
},
{
  texto: "Quin decret català desenvolupa la Llei 3/1998 (LIIAA)?",
  opciones: [
    "a) Decret 136/1999",
    "b) Decret 240/2002",
    "c) Decret 815/2013",
    "d) Decret 500/1996"
  ],
  correcta: "a"
},
{
  texto: "Quina llei catalana substitueix la LIIAA i deroga la Llei 3/1998?",
  opciones: [
    "a) Llei 16/2002",
    "b) Llei 20/2009 (PCAA)",
    "c) Llei 21/1990",
    "d) Llei 5/2013"
  ],
  correcta: "b"
},
{
  texto: "Quan entra en vigor la Llei 20/2009 (PCAA)?",
  opciones: [
    "a) El 2008",
    "b) L’agost de 2010",
    "c) El 2013",
    "d) El 2016"
  ],
  correcta: "b"
},
{
  texto: "Què estableix la Llei 20/2009 respecte a la naturalesa dels permisos?",
  opciones: [
    "a) Que són indefinits i no cal renovació",
    "b) Que tenen data de caducitat i requereixen controls periòdics",
    "c) Que només s’apliquen a empreses públiques",
    "d) Que es poden renovar automàticament cada 20 anys"
  ],
  correcta: "b"
},
{
  texto: "Quin tipus de control fan les Entitats Ambientals Col·laboradores (EAC)?",
  opciones: [
    "a) Controlen el compliment ambiental i realitzen inspeccions periòdiques",
    "b) Gestionen els permisos d’obra nova",
    "c) Fan controls de seguretat alimentària",
    "d) Només elaboren informes econòmics"
  ],
  correcta: "a"
},
{
  texto: "Com classifica la Llei 20/2009 les activitats segons el seu impacte?",
  opciones: [
    "a) Annex I (alt), Annex II (mitjà) i Annex III (baix)",
    "b) Annex A, B i C",
    "c) Nivell 1, 2 i 3 segons potència elèctrica",
    "d) Industrial, comercial i agrícola"
  ],
  correcta: "a"
},
{
  texto: "Qui atorga les autoritzacions ambientals per a activitats de l’Annex I a Catalunya?",
  opciones: [
    "a) Els ajuntaments",
    "b) Els consells comarcals",
    "c) La Generalitat de Catalunya",
    "d) El Ministeri per a la Transició Ecològica"
  ],
  correcta: "c"
},
{
  texto: "Qui té competència per a les activitats dels annexos II i III a Catalunya?",
  opciones: [
    "a) Ajuntaments i consells comarcals si hi ha menys de 50.000 habitants",
    "b) Només la Generalitat",
    "c) El Parlament Europeu",
    "d) Els inspectors del Ministeri"
  ],
  correcta: "a"
},
{
  texto: "Quin és el termini màxim per resoldre un expedient d’autorització ambiental segons l’annex I?",
  opciones: [
    "a) 4 mesos",
    "b) 6 mesos",
    "c) 8 mesos",
    "d) 12 mesos"
  ],
  correcta: "c"
},
{
  texto: "Quin és el termini per resoldre una llicència ambiental d’un Annex II?",
  opciones: [
    "a) 4 mesos",
    "b) 6 mesos",
    "c) 8 mesos",
    "d) 10 mesos"
  ],
  correcta: "b"
},
{
  texto: "Què implica el silenci administratiu negatiu a la Llei 20/2009?",
  opciones: [
    "a) Que si no hi ha resposta dins del termini, l’activitat pot començar igualment",
    "b) Que si no hi ha resolució dins del termini, l’activitat no pot iniciar-se",
    "c) Que l’activitat queda autoritzada automàticament",
    "d) Que cal tornar a presentar la sol·licitud sense cost"
  ],
  correcta: "b"
},
{
  texto: "Què permet el règim de comunicació de l’Annex III?",
  opciones: [
    "a) Començar l’activitat l’endemà de la comunicació a l’ajuntament",
    "b) Esperar una inspecció prèvia obligatòria",
    "c) Demanar una autorització de nivell superior",
    "d) Fer una avaluació ambiental completa"
  ],
  correcta: "a"
}
];
// --- FRASES DE ÁNIMO ---
const frases_animo = [
  "¡Muy bien! 😎",
  "¡Eso es, perfecto, te camelo caramelo! 🔥",
  "¡Ole tú huevos! 💪",
  "¡Exacto, estás on fire! 🚀",
  "¡Qué máquina eres! 😍",
  "¡Correcto, así se hace! 👏",
  "¡Te lo sabes de memoria ya! 💥"
];

// --- VARIABLES ---
let i = 0;
let puntuacion = 0;
let preguntasParaEsteTest = [];

// --- FUNCIONES ---

/**
 * Baraja un array aleatoriamente (algoritmo Fisher-Yates).
 * @param {Array} array El array a barajar.
 */
function barajarPreguntas(array) {
  let currentIndex = array.length,  randomIndex;

  while (currentIndex != 0) {
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex--;
    [array[currentIndex], array[randomIndex]] = [
      array[randomIndex], array[currentIndex]];
  }
  return array;
}

/**
 * Muestra un mensaje en el chat.
 * @param {string} texto El contenido del mensaje.
 * @param {string} tipo 'bot' o 'user'.
 */
function mostrarMensaje(texto, tipo) {
  const chat = document.getElementById("chat");
  const msg = document.createElement("div");
  msg.classList.add("message", tipo);
  // Convierte los saltos de línea (\n) en etiquetas <br>
  msg.innerHTML = texto.replace(/\n/g, "<br>");
  chat.appendChild(msg);
  chat.scrollTop = chat.scrollHeight;
}

/**
 * Muestra la pregunta actual y sus opciones en un solo mensaje.
 */
function mostrarPregunta() {
  // Usa el array de 20 preguntas
  if (!preguntasParaEsteTest[i]) return;

  const p = preguntasParaEsteTest[i];
  // Une la pregunta y las opciones en un solo texto
  const textoCompleto = `${p.texto}\n\n${p.opciones.join("\n")}`;
  mostrarMensaje(textoCompleto, "bot");
}

/**
 * Procesa la respuesta del usuario.
 * @param {string} opcionElegida "a", "b", "c" o "d".
 */
function responder(opcionElegida) {
  // Usa el array de 20 preguntas
  if (!preguntasParaEsteTest[i]) return;

  const p = preguntasParaEsteTest[i];
  // Muestra solo la letra, como pediste
  mostrarMensaje(`${opcionElegida.toUpperCase()}`, "user");

  if (opcionElegida === p.correcta) {
    puntuacion++;
    mostrarMensaje(frases_animo[Math.floor(Math.random() * frases_animo.length)], "bot");
  } else {
    mostrarMensaje(`❌ Incorrecto. La respuesta correcta era ${p.correcta.toUpperCase()}.`, "bot");
  }

  i++;
  // Comprueba si quedan preguntas en el array de 20
  if (i < preguntasParaEsteTest.length) {
    setTimeout(mostrarPregunta, 800);
  } else {
    setTimeout(() => {
      // Muestra la puntuación final sobre 20 (o el total que haya)
      mostrarMensaje(`🏁 Has acertado ${puntuacion} de ${preguntasParaEsteTest.length} preguntas. 💡`, "bot");
      desactivarBotones();
    }, 800);
  }
}

/**
 * Desactiva los botones de opción al final del test.
 */
function desactivarBotones() {
  document.querySelectorAll(".btn-opcion").forEach(btn => btn.disabled = true);
}

// --- ARRANQUE ---
document.addEventListener("DOMContentLoaded", () => {
  i = 0;
  puntuacion = 0;
  
  // 1. Barajamos TODO el array de preguntas
  barajarPreguntas(preguntas); 
  
  // 2. Nos quedamos solo con las 20 primeras (o menos, si el array es más corto)
  preguntasParaEsteTest = preguntas.slice(0, 20); 

  mostrarMensaje(`🧠 Bienvenido al test. Se han elegido ${preguntasParaEsteTest.length} preguntas al azar. 💬`, "bot");
  setTimeout(mostrarPregunta, 500);

  document.getElementById("btnA").onclick = () => responder("a");
  document.getElementById("btnB").onclick = () => responder("b");
  document.getElementById("btnC").onclick = () => responder("c");
  document.getElementById("btnD").onclick = () => responder("d");
});


